<!DOCTYPE html>
<html lang="gu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#2e7d32" />
  <link rel="manifest" href="manifest.json" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;500;600&display=swap" rel="stylesheet" />
  <title>àª¦à«ˆàª¨àª¿àª• àªµà«àª¯àªµàª¸àª¾àª¯ àª°à«‡àª•à«‹àª°à«àª¡</title>
  <style>
    :root {
      --primary-bg: #000;
      --container-bg: #111;
      --input-bg: #222;
      --gold: gold;
      --text-color: #fff;
      --border-radius: 12px;
      --font-size-base: 16px;
      --font-size-lg: 18px;
      --font-size-sm: 14px;
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      background-color: var(--primary-bg);
      color: var(--text-color);
      font-family: 'Noto Sans Gujarati', 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
      font-size: var(--font-size-base);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
      border-radius: var(--border-radius);
      background-color: var(--container-bg);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    
    h1 {
      color: var(--gold);
      text-align: center;
      margin-bottom: 1.5rem;
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    
    h2 {
      color: var(--gold);
      margin-top: 2rem;
      font-size: 1.5rem;
      border-bottom: 1px solid #333;
      padding-bottom: 0.5rem;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    form input, form button, select {
      width: 100%;
      margin: 0.5rem 0;
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid #333;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: var(--font-size-base);
    }
    
    form input::placeholder {
      color: #aaa;
    }
    
    form button {
      background: var(--gold);
      color: black;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      grid-column: 1 / -1;
      margin-top: 1rem;
    }
    
    form button:hover {
      background: #ffd700;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
    }
    
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: var(--input-bg);
      border-radius: var(--border-radius);
    }
    
    .filter-section select {
      width: auto;
      min-width: 120px;
      margin: 0;
    }
    
    #showMonthBtn, #showArchivesBtn {
      padding: 0.8rem 1.5rem;
      background: var(--gold);
      color: black;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .table-container {
      overflow-x: auto;
      margin-top: 2rem;
      border-radius: var(--border-radius);
      background-color: var(--container-bg);
      position: relative;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text-color);
      min-width: 1000px;
    }
    
    th, td {
      padding: 0.8rem;
      border: 1px solid #333;
      text-align: center;
      font-size: var(--font-size-base);
    }
    
    th {
      background: var(--input-bg);
      color: var(--gold);
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    
    tr {
      background: #1a1a1a;
    }
    
    tr:nth-child(even) {
      background: #1f1f1f;
    }
    
    .action-btn {
      padding: 0.5rem 1rem;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: background 0.2s;
    }
    
    .action-btn:hover {
      background: #b71c1c;
    }
    
    .restore-btn {
      padding: 0.5rem 1rem;
      background: #2e7d32;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: var(--font-size-sm);
      transition: background 0.2s;
    }
    
    .restore-btn:hover {
      background: #1b5e20;
    }
    
    #downloadPdfBtn {
      margin-top: 1.5rem;
      padding: 0.8rem 1.5rem;
      background: var(--gold);
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: block;
      width: 100%;
      transition: all 0.2s;
    }
    
    #downloadPdfBtn:hover {
      background: #ffd700;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
    }
    
    #noEntries {
      text-align: center;
      padding: 2rem;
      color: #aaa;
      font-style: italic;
    }
    
    .archive-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .archive-item {
      background: var(--input-bg);
      padding: 1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .archive-item:hover {
      background: #333;
      transform: translateY(-2px);
    }
    
    /* Improved responsive design */
    @media (max-width: 1024px) {
      .container {
        padding: 1.5rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .form-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 0.5rem;
        font-size: var(--font-size-lg);
      }
      
      .container {
        padding: 1rem;
        border-radius: 8px;
      }
      
      h1 {
        font-size: 1.6rem;
        margin-bottom: 1rem;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
        gap: 0.8rem;
      }
      
      form input, form button, select {
        padding: 0.9rem;
        font-size: var(--font-size-lg);
      }
      
      .filter-section {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-section select {
        width: 100%;
      }
      
      th, td {
        padding: 0.7rem;
        font-size: var(--font-size-sm);
      }
      
      .archive-list {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      body {
        font-size: var(--font-size-lg);
      }
      
      .container {
        padding: 0.8rem;
      }
      
      h1 {
        font-size: 1.4rem;
      }
      
      form input, form button, select {
        padding: 0.8rem;
        font-size: var(--font-size-lg);
      }
      
      th, td {
        padding: 0.5rem;
        font-size: var(--font-size-sm);
      }
      
      .action-btn, .restore-btn {
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
      }
    }
    
    /* High contrast mode for better readability */
    @media (prefers-contrast: high) {
      :root {
        --text-color: #fff;
        --input-bg: #000;
        --container-bg: #111;
      }
      
      form input, select {
        border: 2px solid var(--gold);
      }
      
      tr {
        background: #000;
      }
      
      tr:nth-child(even) {
        background: #111;
      }
    }
    
    /* Larger text for older users */
    .text-large {
      font-size: 1.2rem;
    }
    
    /* Focus styles for accessibility */
    button:focus, input:focus, select:focus {
      outline: 2px solid var(--gold);
      outline-offset: 2px;
    }
    
    .hidden {
      display: none;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 1rem;
      border-bottom: 1px solid #333;
    }
    
    .tab {
      padding: 0.8rem 1.5rem;
      background: var(--input-bg);
      border: none;
      color: var(--text-color);
      cursor: pointer;
      font-weight: 600;
      border-radius: 8px 8px 0 0;
      margin-right: 0.5rem;
    }
    
    .tab.active {
      background: var(--gold);
      color: black;
    }
    
    .archive-search {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
    }
    
    .archive-search input {
      flex: 1;
      padding: 0.8rem;
      border-radius: 8px;
      border: 1px solid #333;
      background: var(--input-bg);
      color: var(--text-color);
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body>
  <div class="container">
    <h1>àª¦à«ˆàª¨àª¿àª• àªµà«àª¯àªµàª¸àª¾àª¯ àª°à«‡àª•à«‹àª°à«àª¡</h1>
    
    <div class="tabs">
      <button class="tab active" id="currentTab">àªµàª°à«àª¤àª®àª¾àª¨ àª®àª¹àª¿àª¨à«‹</button>
      <button class="tab" id="archiveTab">àªœà«‚àª¨àª¾àª‚ àª°à«‡àª•à«‹àª°à«àª¡</button>
    </div>
    
    <div id="currentMonthSection">
      <form id="entryForm">
        <div class="form-grid">
          <input type="date" id="date" required class="text-large" />
          <input type="number" id="dailyCollection" placeholder="àª¡à«‡àª²à«€" required class="text-large" />
          <input type="number" id="work" placeholder="àª•àª¾àª®" required class="text-large" />
          <input type="number" id="google" placeholder="àª—à«‚àª—àª²" required class="text-large" />
          <input type="number" id="earned" placeholder="àª‰àªªàª¾àª¡" required class="text-large" />
          <input type="text" id="googleExpenseNote" placeholder="àª—à«‚àª—àª² àª–àª°à«àªš àª¨à«Œàª‚àª˜" class="text-large" />
          <input type="number" id="googlePay" placeholder="àª—à«‚àª—àª² àªªà«‡" class="text-large" />
          <input type="text" id="cashExpenseNote" placeholder="àª°à«‹àª•àª¡ àª–àª°à«àªš àª¨à«Œàª‚àª˜" class="text-large" />
          <input type="number" id="totalExpense" placeholder="àª°à«‹àª•àª¡ àª–àª°à«àªš" class="text-large" />
        </div>
        <button type="submit" class="text-large">àªàª¨à«àªŸà«àª°à«€ àª‰àª®à«‡àª°à«‹</button>
      </form>

      <div class="filter-section">
        <select id="yearSelector" class="text-large">
          <!-- Years will be populated by JS -->
        </select>
        <select id="monthSelector" class="text-large">
          <!-- Months will be populated by JS -->
        </select>
        <button id="showMonthBtn" class="text-large">àª®àª¹àª¿àª¨à«‹ àª¬àª¤àª¾àªµà«‹</button>
      </div>

      <h2>àªµàª°à«àª¤àª®àª¾àª¨ àª®àª¹àª¿àª¨à«‹: <span id="currentMonthDisplay"></span></h2>
      <div class="table-container">
        <table id="entriesTable">
          <thead>
            <tr>
              <th>àª•à«àª°àª® àª¸àª‚àª–à«àª¯àª¾</th>
              <th>àª¤àª¾àª°à«€àª–</th>
              <th>àª¡à«‡àª²à«€</th>
              <th>àª•àª¾àª®</th>
              <th>àª—à«‚àª—àª²</th>
              <th>àª•à«àª² àª•àª¾àª®</th>
              <th>àª‰àªªàª¾àª¡</th>
              <th>àªœàª®àª¾</th>
              <th>àª—à«‚àª—àª² àª–àª°à«àªš àª¨à«Œàª‚àª˜</th>
              <th>àª—à«‚àª—àª² àªªà«‡</th>
              <th>àª°à«‹àª•àª¡ àª–àª°à«àªš àª¨à«Œàª‚àª˜</th>
              <th>àª°à«‹àª•àª¡ àª–àª°à«àªš</th>
              <th>àªàª•àª¶àª¨</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>
      
      <button id="downloadPdfBtn" class="text-large">PDF àª¡àª¾àª‰àª¨àª²à«‹àª¡ àª•àª°à«‹</button>
      <button id="downloadBackupBtn" class="text-large">ğŸ’¾ àª¬à«‡àª•àª…àªª àª¸à«‡àªµ àª•àª°à«‹</button>
      <button id="archiveNowBtn" class="text-large">ğŸ“¦ àª† àª®àª¹àª¿àª¨à«‹ àª†àª°à«àª•àª¾àª‡àªµ àª•àª°à«‹</button>

      <p id="noEntries">àª•à«‹àªˆ àªàª¨à«àªŸà«àª°à«€ àª¨àª¥à«€.</p>
    </div>

    <div id="archivesSection" class="hidden">
      <div class="archive-search">
        <input type="text" id="archiveSearch" placeholder="àª®àª¹àª¿àª¨à«‹ àª¶à«‹àª§à«‹..." class="text-large">
        <button id="searchArchiveBtn" class="text-large">àª¶à«‹àª§à«‹</button>
      </div>
      
      <h2>àªœà«‚àª¨àª¾àª‚ àª®àª¹àª¿àª¨àª¾àª“àª¨àª¾àª‚ àª°à«‡àª•à«‹àª°à«àª¡</h2>
      <div id="archivesList" class="archive-list">
        <!-- Archived months will be populated here -->
      </div>
    </div>
  </div>

  <script>
  // âœ… Manual Archive
  document.getElementById('archiveNowBtn').addEventListener('click', () => {
    const currentMonthKey = new Date().toISOString().slice(0, 7); // YYYY-MM
    let entries = JSON.parse(localStorage.getItem(currentMonthKey)) || [];

    if (entries.length === 0) {
      alert("àª† àª®àª¹àª¿àª¨à«‡ àª•à«‹àªˆ àªàª¨à«àªŸà«àª°à«€ àª¨àª¥à«€.");
      return;
    }

    if (confirm("àª¶à«àª‚ àª¤àª®à«‡ àª† àª®àª¹àª¿àª¨àª¾ àª¨à«‡ Archive àª®àª¾àª‚ àª–àª¸à«‡àª¡àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?")) {
      // Archive àª®àª¾àª‚ àª¸àª‚àª—à«àª°àª¹
      localStorage.setItem(`archive-${currentMonthKey}`, JSON.stringify(entries));

      // Current month àª–àª¾àª²à«€
      localStorage.removeItem(currentMonthKey);

      alert("àª®àª¹àª¿àª¨à«‹ àª¸àª«àª³àª¤àª¾àªªà«‚àª°à«àªµàª• Archive àª¥àª¯à«‹!");
      location.reload(); // àªªà«‡àªœ àª°àª¿àª²à«‹àª¡ àª•àª°à«€àª¨à«‡ àª¤àª¾àªœà«àª‚ view
    }
  });
</script>


  <script>
  // âœ… Backup Download (Save All Data)
  document.getElementById('downloadBackupBtn').addEventListener('click', function () {
    const allData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      // àª«àª•à«àª¤ àª…àª®àª¾àª°à«€ month/archives àª•à«€àª“ àª¸à«‡àªµ àª•àª°àªµàª¾
      if (key.match(/^\d{4}-\d{2}$/) || key.startsWith("archive-")) {
        allData[key] = JSON.parse(localStorage.getItem(key));
      }
    }

    if (Object.keys(allData).length === 0) {
      alert("àª•à«‹àªˆ àª¡à«‡àªŸàª¾ àª®àª³à«àª¯à«‹ àª¨àª¥à«€.");
      return;
    }

    const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'business-backup.json';
    link.click();
  });
</script>


  <script>
    const entryForm = document.getElementById('entryForm');
    const entriesTableBody = document.querySelector('#entriesTable tbody');
    const noEntriesMsg = document.getElementById('noEntries');
    const currentMonthDisplay = document.getElementById('currentMonthDisplay');
    const currentMonthSection = document.getElementById('currentMonthSection');
    const archivesSection = document.getElementById('archivesSection');
    const archivesList = document.getElementById('archivesList');
    const currentTab = document.getElementById('currentTab');
    const archiveTab = document.getElementById('archiveTab');
    const archiveSearch = document.getElementById('archiveSearch');
    const searchArchiveBtn = document.getElementById('searchArchiveBtn');

    const gujaratiDays = ["àª°àªµàª¿àªµàª¾àª°", "àª¸à«‹àª®àªµàª¾àª°", "àª®àª‚àª—àª³àªµàª¾àª°", "àª¬à«àª§àªµàª¾àª°", "àª—à«àª°à«àªµàª¾àª°", "àª¶à«àª•à«àª°àªµàª¾àª°", "àª¶àª¨àª¿àªµàª¾àª°"];
    const gujaratiMonths = ["àªœàª¾àª¨à«àª¯à«àª†àª°à«€", "àª«à«‡àª¬à«àª°à«àª†àª°à«€", "àª®àª¾àª°à«àªš", "àªàªªà«àª°àª¿àª²", "àª®à«‡", "àªœà«‚àª¨", "àªœà«àª²àª¾àªˆ", "àª‘àª—àª¸à«àªŸ", "àª¸àªªà«àªŸà«‡àª®à«àª¬àª°", "àª‘àª•à«àªŸà«‹àª¬àª°", "àª¨àªµà«‡àª®à«àª¬àª°", "àª¡àª¿àª¸à«‡àª®à«àª¬àª°"];
    
    function getGujaratiDayName(dateString) {
      const date = new Date(dateString);
      return gujaratiDays[date.getDay()];
    }

    function getGujaratiMonthName(month) {
      return gujaratiMonths[month - 1] || month;
    }

    let entries = [];
    let currentMonthKey = getCurrentMonthKey();

    function getCurrentMonthKey() {
      const now = new Date();
      return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    function getMonthKeyFromDate(date) {
      const d = new Date(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function loadCurrentMonthEntries() {
      entries = JSON.parse(localStorage.getItem(currentMonthKey) || '[]');
      updateCurrentMonthDisplay();
    }

    function saveEntries() {
      localStorage.setItem(currentMonthKey, JSON.stringify(entries));
    }

    function updateCurrentMonthDisplay() {
      const [year, month] = currentMonthKey.split('-');
      currentMonthDisplay.textContent = `${getGujaratiMonthName(parseInt(month))} ${year}`;
    }

    function checkMonthChangeAndArchive() {
      const storedMonth = localStorage.getItem('lastSavedMonth');
      const nowMonth = getCurrentMonthKey();

      if (storedMonth && storedMonth !== nowMonth) {
        // Archive the previous month's data if it exists and has entries
        const previousMonthEntries = JSON.parse(localStorage.getItem(storedMonth) || '[]');
        if (previousMonthEntries.length > 0) {
          // Save to archives with a specific key format
          localStorage.setItem(`archive-${storedMonth}`, JSON.stringify(previousMonthEntries));
          
          // Clear the previous month's data from regular storage
          localStorage.removeItem(storedMonth);
        }
      }
      
      // Update the last saved month to current month
      localStorage.setItem('lastSavedMonth', nowMonth);
      currentMonthKey = nowMonth;
      loadCurrentMonthEntries();
    }

    function populateArchivesList(searchTerm = '') {
      archivesList.innerHTML = '';
      let hasArchives = false;
      const archiveKeys = [];
      
      // Collect all archive keys
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('archive-')) {
          archiveKeys.push(key);
        }
      }
      
      // Sort archives by date (newest first)
      archiveKeys.sort().reverse();
      
      // Filter by search term if provided
      const filteredKeys = searchTerm ? 
        archiveKeys.filter(key => {
          const monthYear = key.replace('archive-', '');
          const [year, month] = monthYear.split('-');
          const monthName = getGujaratiMonthName(parseInt(month));
          return monthName.toLowerCase().includes(searchTerm.toLowerCase()) || 
                 year.includes(searchTerm);
        }) : 
        archiveKeys;
      
      if (filteredKeys.length === 0) {
        archivesList.innerHTML = '<p>àª•à«‹àªˆ àª†àª°à«àª•àª¾àª‡àªµ àª®àª³à«àª¯à«àª‚ àª¨àª¥à«€</p>';
        return;
      }
      
      filteredKeys.forEach(key => {
        hasArchives = true;
        const monthYear = key.replace('archive-', '');
        const [year, month] = monthYear.split('-');
        const archiveData = JSON.parse(localStorage.getItem(key) || '[]');
        
        const archiveItem = document.createElement('div');
        archiveItem.className = 'archive-item';
        archiveItem.innerHTML = `
          <div><strong>${getGujaratiMonthName(parseInt(month))} ${year}</strong></div>
          <div>àªàª¨à«àªŸà«àª°à«€àª: ${archiveData.length}</div>
          <button class="restore-btn" data-key="${key}">àªœà«àª“</button>
        `;
        archivesList.appendChild(archiveItem);
      });
      
      // Add event listeners to view buttons
      document.querySelectorAll('.restore-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const archiveKey = this.getAttribute('data-key');
          viewArchive(archiveKey);
          
          // Switch to current tab to show the data
          currentTab.click();
        });
      });
    }

    function viewArchive(archiveKey) {
      const archiveData = JSON.parse(localStorage.getItem(archiveKey) || '[]');
      const monthYear = archiveKey.replace('archive-', '');
      
      // Set current month to the archive month
      currentMonthKey = monthYear;
      entries = archiveData;
      saveEntries();
      renderEntries();
      
      // Update the filter selectors to show the archived month
      const [year, month] = monthYear.split('-');
      document.getElementById('yearSelector').value = year;
      document.getElementById('monthSelector').value = month;
      
      updateCurrentMonthDisplay();
    }

    // Initialize the application
    checkMonthChangeAndArchive();

    // Tab functionality
    currentTab.addEventListener('click', () => {
      currentTab.classList.add('active');
      archiveTab.classList.remove('active');
      currentMonthSection.classList.remove('hidden');
      archivesSection.classList.add('hidden');
    });

    archiveTab.addEventListener('click', () => {
      archiveTab.classList.add('active');
      currentTab.classList.remove('active');
      archivesSection.classList.remove('hidden');
      currentMonthSection.classList.add('hidden');
      populateArchivesList();
    });

    // Archive search functionality
    searchArchiveBtn.addEventListener('click', () => {
      populateArchivesList(archiveSearch.value);
    });

    archiveSearch.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        populateArchivesList(archiveSearch.value);
      }
    });

    // Populate monthSelector with available months from localStorage
    function populateYearMonthSelectors() {
      const yearSelector = document.getElementById('yearSelector');
      const monthSelector = document.getElementById('monthSelector');
      yearSelector.innerHTML = '';
      monthSelector.innerHTML = '';

      // Years from 2020 to current year + 1
      const currentYear = new Date().getFullYear();
      for (let y = 2020; y <= currentYear + 1; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelector.appendChild(opt);
      }

      // Months
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement('option');
        opt.value = String(m).padStart(2, '0');
        opt.textContent = m;
        monthSelector.appendChild(opt);
      }

      // Set current year/month as selected
      const [currentYearStr, currentMonthStr] = currentMonthKey.split('-');
      yearSelector.value = currentYearStr;
      monthSelector.value = currentMonthStr;
    }

    document.getElementById('showMonthBtn').addEventListener('click', () => {
      const year = document.getElementById('yearSelector').value;
      const month = document.getElementById('monthSelector').value;
      const key = `${year}-${month}`;
      
      // Check if this is an archived month
      const archiveKey = `archive-${key}`;
      if (localStorage.getItem(archiveKey)) {
        viewArchive(archiveKey);
      } else {
        currentMonthKey = key;
        loadCurrentMonthEntries();
        renderEntries();
      }
    });

    // Call this after DOM is ready
    populateYearMonthSelectors();
    updateCurrentMonthDisplay();

    // Only show entries for the selected month in the table
    function renderEntries() {
      entriesTableBody.innerHTML = '';
      let totalDaily = 0, totalWork = 0, totalGoogle = 0, totalTotalWork = 0, totalEarned = 0, totalDeposited = 0;
      let totalGooglePay = 0, totalGoogleExpense = '', totalCashExpenseNote = '', totalTotalExpense = 0;

      if (entries.length === 0) {
        noEntriesMsg.style.display = 'block';
      } else {
        noEntriesMsg.style.display = 'none';
        entries.forEach((entry, index) => {
          const tr = document.createElement('tr');

          function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${day}-${month}-${year}`;
          }

          const gujaratiDay = entry.gujaratiDay || getGujaratiDayName(entry.date);

          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${formatDate(entry.date)} (${gujaratiDay})</td>
            <td>${entry.dailyCollection}</td>
            <td>${entry.work}</td>
            <td>${entry.google}</td>
            <td>${entry.totalWork}</td>
            <td>${entry.earned}</td>
            <td>${entry.deposited}</td>
            <td>${entry.googleExpense}</td>
            <td>${entry.googlePay}</td>
            <td>${entry.cashExpenseNote || ''}</td>
            <td>${entry.totalExpense}</td>
            <td><button class="action-btn clearEntry" data-index="${index}">àª•àª¾àª¢à«€ àª¨àª¾àª–à«‹</button></td>
          `;
          entriesTableBody.appendChild(tr);

          // Subtotals
          totalDaily += Number(entry.dailyCollection) || 0;
          totalWork += Number(entry.work) || 0;
          totalGoogle += Number(entry.google) || 0;
          totalTotalWork += Number(entry.totalWork) || 0;
          totalEarned += Number(entry.earned) || 0;
          totalDeposited += Number(entry.deposited) || 0;
          totalGooglePay += Number(entry.googlePay) || 0;
          totalTotalExpense += Number(entry.totalExpense) || 0;
        });

        // Add subtotal row
        const tfoot = document.querySelector('#entriesTable tfoot') || document.createElement('tfoot');
        tfoot.innerHTML = `
          <tr style="background:#222;color:gold;font-weight:bold;">
            <td colspan="2">àª•à«àª²</td>
            <td>${totalDaily}</td>
            <td>${totalWork}</td>
            <td>${totalGoogle}</td>
            <td>${totalTotalWork}</td>
            <td>${totalEarned}</td>
            <td>${totalDeposited}</td>
            <td></td>
            <td>${totalGooglePay}</td>
            <td></td>
            <td>${totalTotalExpense}</td>
            <td></td>
          </tr>
        `;
        document.querySelector('#entriesTable').appendChild(tfoot);

        document.querySelectorAll('.clearEntry').forEach(button => {
          button.addEventListener('click', () => {
            const index = button.getAttribute('data-index');
            if (confirm('àª¶à«àª‚ àª¤àª®à«‡ àª–àª°à«‡àª–àª° àª† àªàª¨à«àªŸà«àª°à«€ àª•àª¾àª¢à«€ àª¨àª¾àª–àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?')) {
              entries.splice(index, 1);
              saveEntries();
              renderEntries();
            }
          });
        });
      }
    }

    entryForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const dateInput = document.getElementById('date');
      const date = dateInput.value;
      
      if (!date) {
        alert('àª•à«ƒàªªàª¾ àª•àª°à«€àª¨à«‡ àª¤àª¾àª°à«€àª– àª¦àª¾àª–àª² àª•àª°à«‹');
        return;
      }
      
      // Check if the entry date is from a different month
      const entryMonthKey = getMonthKeyFromDate(date);
      if (entryMonthKey !== currentMonthKey) {
        if (!confirm('àª† àªàª¨à«àªŸà«àª°à«€ àª…àª²àª— àª®àª¹àª¿àª¨àª¾àª¨à«€ àª›à«‡. àª¶à«àª‚ àª¤àª®à«‡ àª¤à«‡àª¨à«‡ àª¯à«‹àª—à«àª¯ àª®àª¹àª¿àª¨àª¾àª®àª¾àª‚ àª‰àª®à«‡àª°àªµàª¾ àª®àª¾àª‚àª—à«‹ àª›à«‹?')) {
          return;
        }
        
        // Save to the correct month's archive
        const existingEntries = JSON.parse(localStorage.getItem(`archive-${entryMonthKey}`) || '[]');
        currentMonthKey = entryMonthKey;
        entries = existingEntries;
      }
      
      const gujaratiDay = getGujaratiDayName(date);

      const dailyCollection = Number(document.getElementById('dailyCollection').value) || 0;
      const work = Number(document.getElementById('work').value) || 0;
      const google = Number(document.getElementById('google').value) || 0;
      const earned = Number(document.getElementById('earned').value) || 0;
      const googlePay = Number(document.getElementById('googlePay').value) || 0;
      const googleExpense = document.getElementById('googleExpenseNote').value || '';
      const cashExpenseNote = document.getElementById('cashExpenseNote').value || '';
      const totalExpense = Number(document.getElementById('totalExpense').value) || 0;

      const totalWork = work + google;
      const deposited = totalWork - earned - dailyCollection - google - totalExpense;

      const entry = {
        date,
        gujaratiDay,
        dailyCollection,
        work,
        google,
        totalWork,
        earned,
        deposited,
        googlePay,
        googleExpense,
        cashExpenseNote,
        totalExpense
      };

      entries.push(entry);
      saveEntries();
      renderEntries();
      entryForm.reset();
      
      // Update display if we changed months
      updateCurrentMonthDisplay();
    });

    
  </script>

  <script>
    document.getElementById('downloadPdfBtn').addEventListener('click', function () {
      const entriesTable = document.getElementById('entriesTable');
      html2canvas(entriesTable).then(function (canvas) {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF({
          orientation: 'landscape',
          unit: 'pt',
          format: 'a4'
        });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = pageWidth - 40;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        pdf.addImage(imgData, 'PNG', 20, 20, imgWidth, imgHeight);
        pdf.save('entries.pdf');
      });
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('âœ… Service Worker Registered'))
        .catch(error => console.error('âŒ SW Registration Failed:', error));
    }

    let deferredPrompt;
    const installBtn = document.getElementById('installAppBtn');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (installBtn) installBtn.style.display = 'inline-block';  

      if (installBtn) {
        installBtn.addEventListener('click', () => {
          installBtn.style.display = 'none';
          deferredPrompt.prompt();
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('âœ… User accepted the install prompt');
            } else {
              console.log('âŒ User dismissed the install prompt');
            }
            deferredPrompt = null;
          });
        });
      }
    });
  </script>
</body>
</html> 